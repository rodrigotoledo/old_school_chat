<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="theme.css">
</head>
<body class="main-page">
  <div id="messages"></div>
  <script type="text/javascript">
    var API_BASE = 'http://localhost:3000/api';

    function formatTime(createdAt) {
      var d = new Date(createdAt);
      var h = d.getHours();
      var m = d.getMinutes();
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function refreshMessages() {
      var el = document.getElementById('messages');
      if (!el) return;
      fetch(API_BASE + '/messages')
        .then(function(r) { return r.json(); })
        .then(function(messages) {
          el.innerHTML = '';
          for (var i = 0; i < messages.length; i++) {
            var msg = messages[i];
            var isYou = msg.participant && msg.participant.name === 'Você';
            var para = msg.recipient && msg.recipient.name ? 'para ' + msg.recipient.name : 'global';
            var name = msg.participant ? msg.participant.name : '';
            var div = document.createElement('div');
            div.className = 'msg' + (isYou ? ' you' : '');
            div.innerHTML =
              '<div class="msg-meta">' +
                '<span class="msg-from">' + escapeHtml(name) + '</span>' +
                '<span class="msg-para"> · ' + escapeHtml(para) + '</span>' +
                '<span class="msg-time">' + formatTime(msg.created_at) + '</span>' +
              '</div>' +
              '<div class="msg-body">' + escapeHtml(msg.body) + '</div>';
            el.appendChild(div);
          }
          el.scrollTop = el.scrollHeight;
        })
        .catch(function() { el.innerHTML = '<p class="msg">Erro ao carregar mensagens.</p>'; });
    }

    window.refreshMessages = refreshMessages;
    refreshMessages();
    setInterval(refreshMessages, 5000);
  </script>
</body>
</html>
