<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="theme.css">
</head>
<body class="footer-page">
  <form id="chatform">
    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td width="10%">
          <label>Para:</label>
          <select name="recipient_id" id="recipient_id">
            <option value="">Todos</option>
          </select>
        </td>
        <td width="10%" align="right">
          <label>Mensagem:</label>
        </td>
        <td width="70%">
          <input type="text" name="body" id="msgbody" placeholder="Digite sua mensagem...">
        </td>
        <td width="10%">
          <input type="submit" value="Enviar">
        </td>
      </tr>
    </table>
  </form>
  <script type="text/javascript">
    var API_BASE = 'http://localhost:3000/api';
    var selectEl = document.getElementById('recipient_id');
    var pendingRecipientId = null;
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'setRecipient') {
        var val = e.data.recipientId || '';
        pendingRecipientId = val;
        selectEl.value = val;
      }
    });
    fetch(API_BASE + '/participants')
      .then(function(r) { return r.json(); })
      .then(function(participants) {
        for (var i = 0; i < participants.length; i++) {
          var p = participants[i];
          if (p.name === 'VocÃª') continue;
          var opt = document.createElement('option');
          opt.value = String(p.id);
          opt.textContent = p.name;
          selectEl.appendChild(opt);
        }
        if (pendingRecipientId !== null) {
          selectEl.value = pendingRecipientId;
        }
      });
    document.getElementById('chatform').onsubmit = function(e) {
      e.preventDefault();
      var bodyEl = document.getElementById('msgbody');
      var body = bodyEl.value;
      if (!body || body.trim().length === 0) return false;
      var recipientEl = document.getElementById('recipient_id');
      var recipientId = recipientEl.value;
      var payload = {
        participant_id: 1,
        message: { body: body.trim(), recipient_id: recipientId === '' ? null : recipientId }
      };
      fetch(API_BASE + '/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(function(res) {
        if (res.status === 201) {
          bodyEl.value = '';
          try { parent.frames['main'].refreshMessages(); } catch (err) {}
        } else {
          res.json().then(function(data) {
            alert(data.errors ? data.errors.join('\n') : 'Erro ao enviar.');
          }).catch(function() { alert('Erro ao enviar.'); });
        }
      }).catch(function() { alert('Erro de rede.'); });
      return false;
    };
  </script>
</body>
</html>
